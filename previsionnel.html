<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrÃ©visionnel Comptable</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0F172A;
  --ink-2: #334155;
  --ink-3: #64748B;
  --ink-4: #94A3B8;
  --surface: #F8FAFC;
  --card: #FFFFFF;
  --border: #E2E8F0;
  --border-focus: #6366F1;
  --blue: #4F46E5;
  --blue-soft: #EEF2FF;
  --teal: #0D9488;
  --teal-soft: #F0FDFA;
  --orange: #EA580C;
  --orange-soft: #FFF7ED;
  --purple: #7C3AED;
  --purple-soft: #F5F3FF;
  --green: #059669;
  --green-soft: #ECFDF5;
  --red: #DC2626;
  --red-soft: #FEF2F2;
  --yellow-input: #FFFBEB;
  --radius: 10px;
  --radius-lg: 16px;
  --shadow-sm: 0 1px 2px rgba(15,23,42,0.05);
  --shadow: 0 4px 24px rgba(15,23,42,0.08);
  --shadow-lg: 0 12px 40px rgba(15,23,42,0.12);
  --font: 'DM Sans', system-ui, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; }
body { font-family: var(--font); background: var(--surface); color: var(--ink); min-height: 100vh; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--ink-4); border-radius: 3px; }

/* TOAST */
.toast { position: fixed; top: 20px; right: 20px; z-index: 200; padding: 12px 24px; border-radius: var(--radius); font-weight: 700; color: #fff; font-size: 13px; box-shadow: var(--shadow-lg); transform: translateY(-8px); opacity: 0; animation: toastIn 0.3s ease forwards; }
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }
@keyframes toastIn { to { transform: translateY(0); opacity: 1; } }

/* PROJECT BAR */
.project-bar { background: var(--ink); padding: 10px 28px; display: flex; align-items: center; gap: 16px; }
.project-bar .label { color: var(--ink-4); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
.project-bar select { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 6px 12px; font-family: var(--font); font-weight: 700; font-size: 13px; cursor: pointer; outline: none; min-width: 200px; }
.project-bar select:focus { border-color: var(--blue); }
.project-bar .actions { margin-left: auto; display: flex; gap: 8px; }
.project-bar button { padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 11px; cursor: pointer; border: none; transition: all 0.15s; }
.project-bar .btn-new { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
.project-bar .btn-new:hover { background: rgba(255,255,255,0.2); }
.project-bar .btn-del { background: rgba(220,38,38,0.15); color: #FCA5A5; }
.project-bar .btn-del:hover { background: rgba(220,38,38,0.3); }

/* HEADER */
.header { background: linear-gradient(135deg, #312E81, #4F46E5); padding: 24px 28px; }
.header h1 { font-size: 24px; font-weight: 800; color: #fff; letter-spacing: -0.03em; }
.header .sub { color: #C7D2FE; font-size: 12px; margin-top: 2px; font-weight: 500; }
.header .params { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; }
.header .param label { display: block; font-size: 10px; font-weight: 700; color: #A5B4FC; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
.header .param input { width: 100%; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.12); color: #fff; font-weight: 600; border: 1px solid rgba(255,255,255,0.18); outline: none; font-size: 13px; font-family: var(--font); }
.header .param input:focus { border-color: #A5B4FC; box-shadow: 0 0 0 3px rgba(165,180,252,0.2); }
.header .param input::placeholder { color: #818CF8; }
.header .io { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
.header .io button { padding: 8px 18px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; border: none; transition: all 0.15s; }
.btn-import { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.25) !important; }
.btn-import:hover { background: rgba(255,255,255,0.25); }
.btn-export { background: linear-gradient(135deg, var(--green), #047857); color: #fff; }
.btn-export:hover { box-shadow: 0 4px 16px rgba(5,150,105,0.4); }
.btn-save { background: linear-gradient(135deg, #F59E0B, #D97706); color: #fff; }
.btn-save:hover { box-shadow: 0 4px 16px rgba(245,158,11,0.4); }


/* TOOLBAR */
.toolbar { padding: 14px 28px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.filter-pills { display: flex; gap: 4px; }
.pill { padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; border: none; cursor: pointer; transition: all 0.2s; }
.pill.active { color: #fff; transform: scale(1.05); box-shadow: var(--shadow-sm); }
.pill:not(.active) { background: var(--border); color: var(--ink-3); }
.search-box { position: relative; flex: 1; max-width: 340px; margin-left: auto; }
.search-box input { width: 100%; padding: 8px 36px 8px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 13px; outline: none; font-family: var(--font); }
.search-box input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
.search-box .clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--ink-4); cursor: pointer; font-size: 16px; }
.btn-add { padding: 8px 18px; border-radius: var(--radius); font-weight: 700; font-size: 12px; background: var(--blue); color: #fff; border: none; cursor: pointer; }

/* TABLE */
.table-wrap { margin: 0 28px 32px; background: var(--card); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th { padding: 10px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #fff; background: var(--ink); white-space: nowrap; text-align: center; }
thead th.col-intitule { text-align: left; min-width: 200px; }
thead th.col-manuel { background: var(--purple); }
thead th.col-total { background: var(--green); }
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
tbody tr:hover { background: #F1F5F9; }
tbody td { padding: 7px 10px; vertical-align: middle; }
td.cell-num { font-family: var(--mono); font-size: 12px; text-align: center; color: var(--ink-3); }
td input.inline { width: 100%; background: transparent; border: none; outline: none; font-family: var(--font); font-size: 13px; color: var(--ink); padding: 2px 4px; border-radius: 4px; }
td input.inline:focus { background: var(--blue-soft); }
td input.inline-mono { font-family: var(--mono); font-weight: 600; font-size: 12px; }

/* OPTION BADGE */
.opt-select { font-weight: 700; font-size: 11px; padding: 5px 8px; border-radius: 8px; border-width: 2px; border-style: solid; cursor: pointer; text-align: center; min-width: 108px; outline: none; appearance: none; -webkit-appearance: none; font-family: var(--font); }

/* INLINE INPUTS */
.input-pct, .input-abo { font-family: var(--mono); font-weight: 700; font-size: 12px; border-radius: 8px; border: 2px solid; padding: 4px 8px; outline: none; text-align: center; }
.input-pct { border-color: var(--teal); color: var(--teal); background: var(--teal-soft); width: 72px; }
.input-pct:focus { box-shadow: 0 0 0 3px rgba(13,148,136,0.15); }
.input-abo { border-color: var(--orange); color: var(--orange); background: var(--orange-soft); width: 100px; text-align: right; }
.input-abo:focus { box-shadow: 0 0 0 3px rgba(234,88,12,0.15); }

/* MANUEL BUTTON */
.btn-manuel { padding: 5px 14px; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; border: 2px solid var(--purple); background: var(--purple-soft); color: var(--purple); transition: all 0.15s; font-family: var(--font); }
.btn-manuel:hover { background: var(--purple); color: #fff; transform: scale(1.03); }

/* TOTAL */
.total-val { font-family: var(--mono); font-weight: 800; font-size: 13px; color: var(--green); }

/* DELETE */
.btn-delete { width: 26px; height: 26px; border-radius: 50%; border: none; background: transparent; color: var(--ink-4); cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.15s; }
tr:hover .btn-delete { opacity: 1; }
.btn-delete:hover { background: var(--red-soft); color: var(--red); }

/* EMPTY STATE */
.empty { text-align: center; padding: 60px 20px; }
.empty .icon { font-size: 52px; margin-bottom: 12px; }
.empty h2 { font-size: 18px; font-weight: 700; color: var(--ink-4); }
.empty p { color: var(--ink-4); font-size: 13px; margin-top: 4px; }

/* MODAL OVERLAY */
.modal-overlay { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(15,23,42,0.55); backdrop-filter: blur(4px); animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal { background: #fff; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 660px; margin: 0 16px; overflow: hidden; animation: slideUp 0.25s ease; }
@keyframes slideUp { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-head { background: linear-gradient(135deg, #7C3AED, #5B21B6); padding: 16px 24px; color: #fff; display: flex; align-items: center; justify-content: space-between; }
.modal-head .title { font-size: 11px; font-weight: 600; opacity: 0.8; }
.modal-head .name { font-size: 17px; font-weight: 800; }
.modal-close { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.18); border: none; color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.modal-close:hover { background: rgba(255,255,255,0.3); }
.modal-body { padding: 24px; }
.modal-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.modal-grid label { display: block; font-size: 10px; font-weight: 700; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 3px; }
.modal-grid input { width: 100%; padding: 9px 10px; text-align: right; font-weight: 700; font-family: var(--mono); border-radius: 8px; border: 2px solid var(--border); color: var(--purple); font-size: 13px; outline: none; }
.modal-grid input:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(124,58,237,0.12); }
.modal-total { margin-top: 18px; display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; border-radius: 12px; background: var(--purple-soft); }
.modal-total .lbl { font-weight: 700; color: var(--ink-2); }
.modal-total .val { font-size: 22px; font-weight: 900; color: var(--purple); font-family: var(--mono); }
.modal-actions { padding: 0 24px 20px; display: flex; gap: 10px; }
.modal-actions button { flex: 1; padding: 10px 0; border-radius: 12px; font-weight: 700; font-size: 13px; cursor: pointer; font-family: var(--font); }
.modal-actions .cancel { background: #fff; border: 2px solid var(--border); color: var(--ink-3); }
.modal-actions .cancel:hover { background: var(--surface); }
.modal-actions .confirm { background: linear-gradient(135deg, #7C3AED, #5B21B6); border: none; color: #fff; }
.modal-actions .confirm:hover { box-shadow: 0 4px 16px rgba(124,58,237,0.35); }

/* NEW PROJECT MODAL */
.new-project-modal { background: #fff; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 400px; margin: 0 16px; overflow: hidden; animation: slideUp 0.25s ease; padding: 24px; }
.new-project-modal h3 { font-size: 18px; font-weight: 800; color: var(--ink); margin-bottom: 16px; }
.new-project-modal input { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 14px; font-family: var(--font); outline: none; margin-bottom: 16px; }
.new-project-modal input:focus { border-color: var(--blue); }
.new-project-modal .btns { display: flex; gap: 10px; }
.new-project-modal .btns button { flex: 1; padding: 10px; border-radius: var(--radius); font-weight: 700; font-size: 13px; cursor: pointer; font-family: var(--font); }

@media (max-width: 768px) {
  .header .params { grid-template-columns: repeat(2, 1fr); }
  .modal-grid { grid-template-columns: repeat(3, 1fr); }
  .toolbar { flex-direction: column; align-items: stretch; }
  .search-box { max-width: none; margin-left: 0; }
}
</style>
</head>
<body>

<div id="app"></div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€
const OPTIONS = ["N-1", "% Evol N-1", "ABO", "MANUEL"];
const OPT_STYLE = {
  "N-1":        { bg:"#EEF2FF", text:"#4F46E5", border:"#4F46E5" },
  "% Evol N-1": { bg:"#F0FDFA", text:"#0D9488", border:"#0D9488" },
  "ABO":        { bg:"#FFF7ED", text:"#EA580C", border:"#EA580C" },
  "MANUEL":     { bg:"#F5F3FF", text:"#7C3AED", border:"#7C3AED" },
};

let state = {
  projects: {},       // { name: { params, accounts } }
  currentProject: "",
  search: "",
  filter: "TOUS",
  modalIdx: null,
  showNewProject: false,
};

// â”€â”€â”€ URL PARAMS â”€â”€â”€
function getUrlParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    projet: p.get("projet") || p.get("project") || "",
    siren: p.get("siren") || "",
    societe: p.get("societe") || p.get("sociÃ©tÃ©") || "",
    exercice: p.get("exercice") || "",
    dateRef: p.get("dateref") || p.get("dateRef") || "",
  };
}

// â”€â”€â”€ STORAGE â”€â”€â”€
function saveToStorage() {
  try { localStorage.setItem("previ_projects", JSON.stringify(state.projects)); } catch(e) {}
}
function loadFromStorage() {
  try {
    const d = localStorage.getItem("previ_projects");
    if (d) state.projects = JSON.parse(d);
  } catch(e) {}
}

function ensureProject(name) {
  if (!name) return;
  if (!state.projects[name]) {
    state.projects[name] = {
      params: { siren: "", societe: "", exercice: "", dateRef: "" },
      accounts: [],
    };
  }
}

function currentData() {
  if (!state.currentProject || !state.projects[state.currentProject]) return null;
  return state.projects[state.currentProject];
}

// â”€â”€â”€ HELPERS â”€â”€â”€
function parseExcelDate(v) {
  if (!v) return "";
  if (v instanceof Date) { const y=v.getFullYear(),m=String(v.getMonth()+1).padStart(2,"0"),d=String(v.getDate()).padStart(2,"0"); return `${y}-${m}-${d}`; }
  if (typeof v === "number") { const d=new Date((v-25569)*86400000); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
  return String(v);
}

function getMonthLabels(ex) {
  if (!ex) return Array.from({length:12},(_,i)=>new Date(2025,i,1).toLocaleDateString("fr-FR",{month:"short",year:"2-digit"}));
  const d = new Date(ex);
  if (isNaN(d)) return Array.from({length:12},(_,i)=>`M${i+1}`);
  return Array.from({length:12},(_,i)=>new Date(d.getFullYear(),d.getMonth()-11+i,1).toLocaleDateString("fr-FR",{month:"short",year:"2-digit"}));
}

function getMonthDates(ex) {
  const base = ex ? new Date(ex) : new Date(2025,11,31);
  if (isNaN(base)) return Array.from({length:12},(_,i)=>new Date(2025,i,1));
  return Array.from({length:12},(_,i)=>new Date(base.getFullYear(),base.getMonth()-11+i,1));
}

let toastTimer = null;
function showToast(msg, type="success") {
  clearTimeout(toastTimer);
  const el = document.getElementById("toast");
  el.textContent = msg; el.className = "toast " + type; el.style.display = "block";
  toastTimer = setTimeout(() => { el.style.display = "none"; }, 3000);
}

function uid() { return Math.random().toString(36).slice(2,9); }

// â”€â”€â”€ IMPORT â”€â”€â”€
function handleImport(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const wb = XLSX.read(evt.target.result, {type:"array", cellDates:true});
      const ws = wb.Sheets["Previ_Data"];
      if (!ws) { showToast("Onglet Previ_Data introuvable","error"); return; }
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});

      let hRow = -1;
      for (let i=0; i<Math.min(rows.length,15); i++) { if (rows[i]?.some(c=>String(c).toUpperCase().includes("COMPTE"))) { hRow=i; break; } }
      if (hRow===-1) { showToast("En-tÃªtes non trouvÃ©es","error"); return; }

      const data = currentData();
      if (!data) return;

      // Parse params
      for (let i=0; i<hRow; i++) {
        const r=rows[i]; if(!r) continue;
        for (let j=0; j<r.length; j++) {
          const cv=String(r[j]||"").toUpperCase();
          if (cv.includes("SIREN")&&r[j+1]) data.params.siren=String(r[j+1]);
          if ((cv.includes("SOCIÃ‰T")||cv.includes("SOCIET"))&&r[j+1]) data.params.societe=String(r[j+1]);
          if (cv.includes("EXERCICE")&&r[j+1]) data.params.exercice=parseExcelDate(r[j+1]);
          if ((cv.includes("RÃ‰F")||cv.includes("REF"))&&r[j+1]) data.params.dateRef=parseExcelDate(r[j+1]);
        }
      }

      const hdr=rows[hRow].map(h=>String(h||"").toUpperCase().trim());
      const idx={};
      hdr.forEach((h,i)=>{
        if(h.includes("COMPTE")&&!h.includes("INTITUL")) idx.compte=i;
        if(h.includes("INTITUL")) idx.intitule=i;
        if(h.includes("OPTION")) idx.option=i;
        if(h.includes("Ã‰VOL")||h.includes("EVOL")) idx.pctEvol=i;
        if(h.includes("ABO")) idx.abo=i;
      });

      const monthCols=[]; hdr.forEach((h,i)=>{ if(h.match(/^MANUEL\d{2}$/)) monthCols.push(i); });

      let manuelMap={};
      const wsM=wb.Sheets["Saisie_Manuel"];
      if(wsM){
        const mr=XLSX.utils.sheet_to_json(wsM,{header:1,defval:""});
        let mh=-1;
        for(let i=0;i<Math.min(mr.length,10);i++){if(mr[i]?.some(c=>String(c).toUpperCase().includes("COMPTE"))){mh=i;break;}}
        if(mh>=0){
          const mHdr=mr[mh].map(h=>String(h||"").toUpperCase().trim());
          const mCi=mHdr.findIndex(h=>h.includes("COMPTE")&&!h.includes("INTITUL"));
          const mMs=mHdr.findIndex((h,i)=>i>2&&h&&!h.includes("TOTAL")&&!h.includes("RETOUR")&&!h.includes("NÂ°")&&!h.includes("COMPTE")&&!h.includes("INTITUL"));
          if(mCi>=0&&mMs>=0) for(let i=mh+1;i<mr.length;i++){if(!mr[i]?.[mCi])continue;manuelMap[String(mr[i][mCi])]=Array.from({length:12},(_,m)=>parseFloat(mr[i][mMs+m])||0);}
        }
      }

      const accs=[];
      for(let i=hRow+1;i<rows.length;i++){
        const r=rows[i]; if(!r||!r[idx.compte])continue;
        const compte=String(r[idx.compte]||"");
        let months=Array(12).fill(0);
        if(manuelMap[compte]) months=manuelMap[compte];
        else if(monthCols.length>=12) months=monthCols.slice(0,12).map(ci=>parseFloat(r[ci])||0);
        accs.push({compte,intitule:String(r[idx.intitule]||""),option:String(r[idx.option]||"N-1"),pctEvol:parseFloat(r[idx.pctEvol])||0,aboAnnuel:parseFloat(r[idx.abo])||0,months,id:uid()});
      }
      data.accounts=accs;
      saveToStorage();
      showToast(`${accs.length} comptes importÃ©s âœ“`);
      render();
    } catch(err) { showToast("Erreur: "+err.message,"error"); }
  };
  reader.readAsArrayBuffer(file);
  e.target.value="";
}

// â”€â”€â”€ EXPORT â”€â”€â”€
function handleExport() {
  const data=currentData();
  if(!data||!data.accounts.length){showToast("Aucun compte","error");return;}
  const wb=XLSX.utils.book_new();
  const p=data.params, accs=data.accounts;

  // Previ_Data
  const pdH=["SIREN","SOCIETE","COMPTE","INTITULES","Exercice","DateRef","OPTIONS","% EVOL N-1","ABO",...Array.from({length:12},(_,i)=>`MANUEL${String(i+1).padStart(2,"0")}`)];
  const pdR=accs.map(a=>[p.siren,p.societe,a.compte,a.intitule,p.exercice?new Date(p.exercice):"",p.dateRef?new Date(p.dateRef):"",a.option,a.option==="% Evol N-1"?a.pctEvol:"",a.option==="ABO"?a.aboAnnuel:"",...(a.option==="MANUEL"?a.months:Array(12).fill(""))]);
  const s1=XLSX.utils.aoa_to_sheet([pdH,...pdR]); s1["!cols"]=pdH.map((_,i)=>({wch:i===3?35:13}));
  XLSX.utils.book_append_sheet(wb,s1,"Previ_Data");

  // Saisie_Manuel
  const ml=getMonthLabels(p.exercice);
  const smH=["COMPTE","INTITULE",...ml.map(l=>l.toUpperCase()),"TOTAL"];
  const smR=accs.map(a=>{const m=a.option==="MANUEL"?a.months:Array(12).fill(0);return[a.compte,a.intitule,...m,m.reduce((s,v)=>s+v,0)];});
  const s2=XLSX.utils.aoa_to_sheet([smH,...smR]); s2["!cols"]=smH.map((_,i)=>({wch:i===1?35:13}));
  XLSX.utils.book_append_sheet(wb,s2,"Saisie_Manuel");

  // DatePrevi
  const dpH=["Date","Siren","Ratio","MoisNum"];
  const mDates=getMonthDates(p.exercice);
  const dpR=mDates.map((d,i)=>[d,p.siren,1/12,i+1]);
  const s3=XLSX.utils.aoa_to_sheet([dpH,...dpR]); s3["!cols"]=[{wch:14},{wch:14},{wch:14},{wch:10}];
  for(let i=0;i<12;i++){const c=s3[XLSX.utils.encode_cell({r:i+1,c:0})];if(c)c.z="mmm-yy";}
  XLSX.utils.book_append_sheet(wb,s3,"DatePrevi");

  XLSX.writeFile(wb,`Previ_${state.currentProject||"Export"}.xlsx`);
  showToast("Excel exportÃ© âœ“");
}


// â”€â”€â”€ PUBLISH TO POWER BI SOURCE (API) â”€â”€â”€
// IMPORTANT : le navigateur ne doit JAMAIS se connecter directement Ã  SQL/SharePoint.
// -> On passe par une API sÃ©curisÃ©e (Entra ID / token / clÃ©) que tu hÃ©berges (Azure Functions / App Service).



function buildPreviRows() {
  const data = currentData();
  if (!data) return [];
  const p = data.params;
  const monthDates = getMonthDates(p.exercice); // 12 dates (1er du mois)
  const rows = [];

  // RÃ¨gle : on pousse des lignes mensuelles "prÃªtes Ã  agrÃ©ger" (1 ligne = 1 compte x 1 mois)
  // Colonnes cible (exemple) : SIREN, Mois_Annee, COMPTE, OPTIONS
  data.accounts.forEach(a => {
    monthDates.forEach((d, i) => {
      let montant = 0;

      if (a.option === "MANUEL") montant = (a.months?.[i] || 0);
      else if (a.option === "ABO") montant = (parseFloat(a.aboAnnuel) || 0) / 12;
      else {
        // N-1 / % Evol N-1 : Ã  calculer cÃ´tÃ© modÃ¨le si tu as N-1 en source
        montant = 0;
      }

      rows.push({
        SIREN: String(p.siren || ""),
        Mois_Annee: d.toISOString().slice(0,10),        // YYYY-MM-DD
        COMPTE: String(a.compte || ""),
        OPTIONS: String(a.option || ""),
        Montant_Budget_Mensuel_C: Number(montant || 0)
      });
    });
  });

  return rows;
}


// â”€â”€â”€ RENDER â”€â”€â”€
function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k,v]) => {
    if (k === "style" && typeof v === "object") Object.assign(el.style, v);
    else if (k.startsWith("on")) el.addEventListener(k.slice(2).toLowerCase(), v);
    else if (k === "className") el.className = v;
    else if (k === "value") el.value = v;
    else if (k === "selected") el.selected = v;
    else if (k === "checked") el.checked = v;
    else if (k === "type") el.type = v;
    else if (k === "placeholder") el.placeholder = v;
    else if (k === "step") el.step = v;
    else if (k === "accept") el.accept = v;
    else if (k === "htmlFor") el.htmlFor = v;
    else if (k === "innerHTML") el.innerHTML = v;
    else el.setAttribute(k, v);
  });
  children.flat(Infinity).forEach(c => {
    if (c == null) return;
    el.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  });
  return el;
}

function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";
  app.appendChild(h("div", {id:"toast",className:"toast",style:{display:"none"}}));

  const data = currentData();
  const projNames = Object.keys(state.projects).sort();

  // â”€â”€ PROJECT BAR â”€â”€
  const projSelect = h("select", {onChange: e => { state.currentProject=e.target.value; render(); }},
    ...projNames.map(n => h("option", {value:n, selected:n===state.currentProject}, n)),
    projNames.length===0 ? h("option",{value:""},"â€” Aucun projet â€”") : null
  );

  const fileInput = h("input", {type:"file", accept:".xlsx,.xls", style:{display:"none"}, onChange: handleImport});

  app.appendChild(h("div", {className:"project-bar"},
    h("span",{className:"label"},"ðŸ“‚ Projet :"),
    projSelect,
    h("div",{className:"actions"},
      h("button",{className:"btn-new",onClick:()=>{state.showNewProject=true;render();}},"+ Nouveau"),
      projNames.length>0 ? h("button",{className:"btn-del",onClick:()=>{
        if(state.currentProject&&confirm(`Supprimer le projet "${state.currentProject}" ?`)){
          delete state.projects[state.currentProject];
          state.currentProject=Object.keys(state.projects)[0]||"";
          saveToStorage();render();
        }
      }},"ðŸ—‘ Supprimer") : null
    )
  ));

  if (!data) {
    app.appendChild(h("div",{className:"header"},
      h("h1",{},"âš¡ PrÃ©visionnel Comptable"),
      h("p",{className:"sub"},"CrÃ©ez ou sÃ©lectionnez un projet pour commencer")
    ));
    app.appendChild(h("div",{className:"table-wrap"},h("div",{className:"empty"},
      h("div",{className:"icon"},"ðŸ“‚"),h("h2",{},"Aucun projet sÃ©lectionnÃ©"),h("p",{},"Cliquez '+ Nouveau' pour crÃ©er votre premier projet")
    )));
    if(state.showNewProject) renderNewProjectModal(app);
    return;
  }

  const params = data.params;
  const accounts = data.accounts;
  const monthLabels = getMonthLabels(params.exercice);

  // â”€â”€ HEADER â”€â”€
  const paramInputs = [
    {k:"siren",l:"SIREN",t:"text",p:"Ex: 393266770"},
    {k:"societe",l:"SOCIÃ‰TÃ‰",t:"text",p:"Nom"},
    {k:"exercice",l:"EXERCICE (fin)",t:"date",p:""},
    {k:"dateRef",l:"DATE COMPTA RÃ‰F.",t:"date",p:""},
  ].map(({k,l,t,p}) => h("div",{className:"param"},
    h("label",{},l),
    h("input",{type:t,value:params[k]||"",placeholder:p,onInput:e=>{params[k]=e.target.value;saveToStorage();}})
  ));

  app.appendChild(h("div",{className:"header"},
    h("h1",{},"âš¡ ",state.currentProject),
    h("p",{className:"sub"},"PrÃ©visionnel comptable"),
    h("div",{className:"params"},...paramInputs),
    h("div",{className:"io"},
      h("button",{className:"btn-import",onClick:()=>fileInput.click()},"ðŸ“¥ Importer Excel"),
      fileInput,
      h("button",{className:"btn-export",onClick:handleExport},"ðŸ“¤ Exporter Excel"),      h("button",{className:"btn-save",onClick:()=>{saveToStorage();showToast("Projet sauvegardÃ© âœ“");}},"ðŸ’¾ Sauvegarder"),
    )
  ));

  // â”€â”€ TOOLBAR â”€â”€
  const stats = {TOUS:accounts.length};
  OPTIONS.forEach(o=>{stats[o]=accounts.filter(a=>a.option===o).length;});
  const pills = [{l:"TOUS",n:stats.TOUS,bg:"#334155"},...OPTIONS.map(o=>({l:o,n:stats[o],bg:OPT_STYLE[o].border}))];

  const searchInput = h("input",{type:"text",value:state.search,placeholder:"ðŸ” Rechercher compte ou intitulÃ©...",
    onInput:e=>{state.search=e.target.value;render();}});
  const clearBtn = state.search ? h("button",{className:"clear",onClick:()=>{state.search="";render();}},"âœ•") : null;

  app.appendChild(h("div",{className:"toolbar"},
    h("div",{className:"filter-pills"},
      ...pills.map(({l,n,bg})=>h("button",{
        className:"pill"+(state.filter===l?" active":""),
        style:state.filter===l?{backgroundColor:bg,color:"#fff"}:{},
        onClick:()=>{state.filter=l;render();}
      },`${l} (${n||0})`))
    ),
    h("div",{className:"search-box"},searchInput,clearBtn),
    h("button",{className:"btn-add",onClick:()=>{accounts.push({compte:"",intitule:"",option:"N-1",pctEvol:0,aboAnnuel:0,months:Array(12).fill(0),id:uid()});saveToStorage();render();}},"+ Ajouter")
  ));

  // â”€â”€ TABLE â”€â”€
  const filtered = accounts.filter((a,i)=>{
    if(state.filter!=="TOUS"&&a.option!==state.filter)return false;
    if(state.search){const s=state.search.toLowerCase();return a.compte.toLowerCase().includes(s)||a.intitule.toLowerCase().includes(s);}
    return true;
  });

  if(!accounts.length){
    app.appendChild(h("div",{className:"table-wrap"},h("div",{className:"empty"},
      h("div",{className:"icon"},"ðŸ“‹"),h("h2",{},"Aucun compte"),h("p",{},"Importez un fichier Excel ou ajoutez des comptes")
    )));
  } else {
    const thead = h("thead",{},h("tr",{},
      ...["NÂ°","COMPTE","INTITULÃ‰","OPTION","% Ã‰VOL","ABO ANNUEL","SAISIE MANUEL","TOTAL",""].map((t,i)=>{
        let cls=""; if(i===2)cls="col-intitule"; if(i===6)cls="col-manuel"; if(i===7)cls="col-total";
        return h("th",{className:cls},t);
      })
    ));

    const tbody = h("tbody",{},
      ...filtered.map(a=>{
        const ri=accounts.indexOf(a);
        const c=OPT_STYLE[a.option]||OPT_STYLE["N-1"];
        const tot=a.option==="ABO"?a.aboAnnuel:a.option==="MANUEL"?a.months.reduce((s,v)=>s+v,0):null;

        // Option select
        const optSel = h("select",{className:"opt-select",style:{backgroundColor:c.bg,color:c.text,borderColor:c.border},
          onChange:e=>{a.option=e.target.value;saveToStorage();render();}},
          ...OPTIONS.map(o=>h("option",{value:o,selected:o===a.option},o))
        );

        // % Evol
        let pctCell;
        if(a.option==="% Evol N-1") {
          pctCell = h("input",{className:"input-pct",type:"number",step:"0.01",value:a.pctEvol||"",
            onInput:e=>{a.pctEvol=parseFloat(e.target.value)||0;saveToStorage();},onFocus:e=>e.target.select()});
        } else { pctCell = h("span",{style:{color:"#CBD5E1"}},"â€”"); }

        // ABO
        let aboCell;
        if(a.option==="ABO") {
          aboCell = h("input",{className:"input-abo",type:"number",value:a.aboAnnuel||"",
            onInput:e=>{a.aboAnnuel=parseFloat(e.target.value)||0;saveToStorage();render();},onFocus:e=>e.target.select()});
        } else { aboCell = h("span",{style:{color:"#CBD5E1"}},"â€”"); }

        // Manuel
        let manCell;
        if(a.option==="MANUEL"){
          const sum=a.months.reduce((s,v)=>s+v,0);
          manCell=h("button",{className:"btn-manuel",onClick:()=>{state.modalIdx=ri;render();}},
            "âœï¸ "+(sum?sum.toLocaleString("fr-FR"):"Saisir"));
        } else { manCell=h("span",{style:{color:"#CBD5E1"}},"â€”"); }

        // Total
        let totCell;
        if(tot!==null) totCell=h("span",{className:"total-val"},tot.toLocaleString("fr-FR"));
        else totCell=h("span",{className:"muted"},"â€”");

        return h("tr",{},
          h("td",{className:"cell-num"},String(ri+1)),
          h("td",{},h("input",{className:"inline inline-mono",value:a.compte,onInput:e=>{a.compte=e.target.value;saveToStorage();}})),
          h("td",{},h("input",{className:"inline",value:a.intitule,onInput:e=>{a.intitule=e.target.value;saveToStorage();}})),
          h("td",{style:{textAlign:"center"}},optSel),
          h("td",{style:{textAlign:"center"}},pctCell),
          h("td",{style:{textAlign:"center"}},aboCell),
          h("td",{style:{textAlign:"center"}},manCell),
          h("td",{style:{textAlign:"center"}},totCell),
          h("td",{},h("button",{className:"btn-delete",onClick:()=>{accounts.splice(ri,1);saveToStorage();render();}},"âœ•"))
        );
      })
    );

    app.appendChild(h("div",{className:"table-wrap"},h("div",{style:{overflowX:"auto"}},h("table",{},thead,tbody))));
  }

  // â”€â”€ MODAL â”€â”€
  if(state.modalIdx!==null && accounts[state.modalIdx]) {
    renderManuelModal(app, accounts[state.modalIdx], monthLabels);
  }

  // â”€â”€ NEW PROJECT MODAL â”€â”€
  if(state.showNewProject) renderNewProjectModal(app);
}

function renderManuelModal(app, account, monthLabels) {
  const vals = [...account.months];

  function updateModal() {
    const inputs = overlay.querySelectorAll("input[data-mi]");
    let total = 0;
    inputs.forEach(inp => { total += parseFloat(inp.value) || 0; });
    overlay.querySelector(".modal-total .val").textContent = total.toLocaleString("fr-FR");
  }

  const grid = h("div",{className:"modal-grid"},
    ...monthLabels.map((label,i)=>h("div",{},
      h("label",{},label),
      h("input",{type:"number","data-mi":String(i),value:vals[i]||"",placeholder:"0",
        onInput:e=>{vals[i]=parseFloat(e.target.value)||0;updateModal();},
        onFocus:e=>e.target.select()})
    ))
  );

  const total = vals.reduce((s,v)=>s+v,0);

  const overlay = h("div",{className:"modal-overlay",onClick:()=>{state.modalIdx=null;render();}},
    h("div",{className:"modal",onClick:e=>e.stopPropagation()},
      h("div",{className:"modal-head"},
        h("div",{},h("div",{className:"title"},"Saisie manuelle"),h("div",{className:"name"},account.compte+" â€” "+account.intitule)),
        h("button",{className:"modal-close",onClick:()=>{state.modalIdx=null;render();}},"âœ•")
      ),
      h("div",{className:"modal-body"},grid,
        h("div",{className:"modal-total"},h("span",{className:"lbl"},"TOTAL ANNUEL"),h("span",{className:"val"},total.toLocaleString("fr-FR")))
      ),
      h("div",{className:"modal-actions"},
        h("button",{className:"cancel",onClick:()=>{state.modalIdx=null;render();}},"Annuler"),
        h("button",{className:"confirm",onClick:()=>{account.months=[...vals];saveToStorage();state.modalIdx=null;render();showToast("Saisie enregistrÃ©e âœ“");}},"âœ“ Valider")
      )
    )
  );
  app.appendChild(overlay);
  setTimeout(()=>{const first=overlay.querySelector('input[data-mi="0"]');if(first)first.focus();},50);
}

function renderNewProjectModal(app) {
  let newName = "";
  const overlay = h("div",{className:"modal-overlay",onClick:()=>{state.showNewProject=false;render();}},
    h("div",{className:"new-project-modal",onClick:e=>e.stopPropagation()},
      h("h3",{},"ðŸ“‚ Nouveau projet"),
      h("input",{type:"text",placeholder:"Nom du projet (ex: Budget 2025 - MaSociÃ©tÃ©)",
        onInput:e=>{newName=e.target.value;}}),
      h("div",{className:"btns"},
        h("button",{style:{background:"#fff",border:"2px solid #E2E8F0",color:"#64748B"},onClick:()=>{state.showNewProject=false;render();}},"Annuler"),
        h("button",{style:{background:"linear-gradient(135deg,#4F46E5,#3730A3)",border:"none",color:"#fff"},onClick:()=>{
          if(!newName.trim()){showToast("Nom requis","error");return;}
          ensureProject(newName.trim());
          // Pre-fill from URL params
          const url = getUrlParams();
          const d = state.projects[newName.trim()];
          if(url.siren) d.params.siren=url.siren;
          if(url.societe) d.params.societe=url.societe;
          if(url.exercice) d.params.exercice=url.exercice;
          if(url.dateRef) d.params.dateRef=url.dateRef;
          state.currentProject=newName.trim();
          state.showNewProject=false;
          saveToStorage();render();showToast("Projet crÃ©Ã© âœ“");
        }},"CrÃ©er")
      )
    )
  );
  app.appendChild(overlay);
  setTimeout(()=>{overlay.querySelector("input")?.focus();},50);
}

// â”€â”€â”€ INIT â”€â”€â”€
function init() {
  loadFromStorage();
  const url = getUrlParams();

  // If ?projet=X is in URL, auto-select/create that project
  if (url.projet) {
    ensureProject(url.projet);
    const d = state.projects[url.projet];
    if (url.siren && !d.params.siren) d.params.siren = url.siren;
    if (url.societe && !d.params.societe) d.params.societe = url.societe;
    if (url.exercice && !d.params.exercice) d.params.exercice = url.exercice;
    if (url.dateRef && !d.params.dateRef) d.params.dateRef = url.dateRef;
    state.currentProject = url.projet;
    saveToStorage();
  } else {
    state.currentProject = Object.keys(state.projects)[0] || "";
  }
  render();
}

init();
</script>
</body>
</html>
